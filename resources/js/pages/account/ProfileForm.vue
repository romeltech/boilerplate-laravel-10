<template>
  <v-card>
    <v-card-title class="text-primary text-capitalize mb-3"
      >Profile Settings</v-card-title
    >
    <v-card-text>
      <Form as="v-form" :validation-schema="validation">
        <Field
          name="full_name"
          v-slot="{ field, errors }"
          v-model="profileData.data.full_name"
        >
          <v-text-field
            v-model="profileData.data.full_name"
            v-bind="field"
            label="Full name"
            variant="outlined"
            class="mb-2"
            :error-messages="errors"
          />
        </Field>
        <Field name="dob" v-slot="{ field, errors }" v-model="profileData.data.dob">
          <v-text-field
            v-bind="field"
            type="date"
            label="Date of Birth"
            :model-value="profileData.data.dob"
            variant="outlined"
            class="mb-2"
            :error-messages="errors"
          />
        </Field>
        <Field
          name="nationality"
          v-slot="{ field, errors }"
          v-model="profileData.data.nationality"
        >
          <v-autocomplete
            v-model="profileData.data.nationality"
            v-bind="field"
            :items="nationalityList"
            item-title="name"
            item-value="name"
            label="Nationality"
            variant="outlined"
            class="mb-2"
            :error-messages="errors"
          ></v-autocomplete>
        </Field>
        <v-btn
          color="primary"
          size="large"
          :loading="profileData.loading"
          @click="saveProfile"
          >Save</v-btn
        >
      </Form>
    </v-card-text>
  </v-card>
</template>
<script setup>
import { ref, watch } from "vue";
import { Form, Field } from "vee-validate";
import * as yup from "yup";
import { useRoute } from "vue-router";
import { axiosToken } from "@/services/axiosToken";
import nationalities from "@/json/nationalities.json";
import { useAuthStore } from "@/stores/auth";

const authStore = useAuthStore();
const route = useRoute();
const emit = defineEmits(["saved"]);
const props = defineProps(["profile"]);
const nationalityList = ref(nationalities);

watch(
  () => props.profile,
  (newVal) => {
    profileData.value.data = { ...profileData.value.data, ...newVal };
  }
);
onMounted(() => {
  profileData.value.data = { ...profileData.value.data, ...props.profile };
});

const profileData = ref({
  loading: false,
  data: {
    user_id: route.params.id,
    full_name: null,
    dob: null,
    nationality: null,
  },
});
profileData.value.data = Object.assign({}, props.user);
watch(
  () => props.user,
  (newVal) => {
    profileData.value.data = Object.assign({}, newVal);
    // profileData.value.data = { ...profileData.value.data, ...newVal };
  }
);
const getProfile = async () => {
  await axiosToken(authStore.token)
    .get("/api/account/profile/" + props.user.id)
    .then((res) => {
      profileData.value.data = Object.assign({}, res.data);
    })
    .catch((err) => {
      profileData.value.loading = false;
      console.log("getProfile", err);
    });
};
getProfile();

// save profile
let validation = yup.object({
  full_name: yup.string(),
  dob: yup.string(),
  nationality: yup.string().notRequired(),
});
const saveProfile = async () => {
  profileData.value.loading = true;
  profileData.value.data = {
    ...profileData.value.data,
    ...{
      id: props.user.id,
    },
  };
  await axiosToken(authStore.token)
    .post("/api/account/profile/save", profileData.value.data)
    .then((response) => {
      profileData.value.loading = false;
      emit("saved", response.data.message);
    })
    .catch((err) => {
      profileData.value.loading = false;
      console.log(err.response.data);
    });
};
</script>
